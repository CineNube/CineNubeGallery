<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cat√°logo | CineNube</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<style>
  body{font-family:Inter,Arial,sans-serif;background:#0e0e0e;color:#fff;margin:0;padding:0}
  header{background:#131313;padding:18px;text-align:center}
  header h1{color:#00aaff;margin:0}
  .container{max-width:1200px;margin:20px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{background:#141414;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;height:420px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
  .thumb{height:260px}
  .thumb img{width:100%;height:100%;object-fit:cover;border-bottom:3px solid #00aaff}
  .content{padding:10px;display:flex;flex-direction:column;flex:1}
  .title{color:#00aaff;font-weight:700;height:46px;overflow:hidden}
  .meta{color:#9aaebf;margin-top:8px}
  .actions{margin-top:auto}
  .btn{background:#00aaff;color:#000;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:700}
  .empty{padding:40px;text-align:center;color:#aaa}
</style>
</head>
<body>
<header><h1>üéûÔ∏è Cat√°logo CineNube</h1></header>
<div class="container">
  <div id="catalog" class="grid"></div>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec";

function safeParseJSON(str){ try{return JSON.parse(str);}catch(e){return null;} }
function parseDateBest(item){ const c=[item.published_at,item.updated,item.updated_at,item.year]; for(const x of c){ if(!x) continue; const t=Date.parse(x); if(!isNaN(t)) return t; } return null; }
function normalizeLink(raw){ if(!raw) return ""; const s=String(raw).trim(); if(s.startsWith("http")) return s; return "https://cinenube.github.io/CineNubeGallery/" + s.replace(/^\/+/,""); }
function shouldOpenBlank(url){ try{const u=new URL(url);return u.hostname !== location.hostname;}catch(e){return false;} }

async function loadCatalog(){
  try{
    const r = await fetch(SHEET_URL);
    const data = await r.json();
    if(!Array.isArray(data)){ document.getElementById("catalog").innerHTML='<div class="empty">Respuesta inv√°lida del WebApp.</div>'; return; }
    const annotated = data.map((it,idx)=>Object.assign({},it,{_ts:parseDateBest(it),_idx:idx}));
    const hasTs = annotated.some(x=>x._ts);
    const sorted = hasTs ? annotated.sort((a,b)=> (b._ts||0)-(a._ts||0)) : annotated.reverse();
    renderGrid(sorted);
  }catch(err){ console.error(err); document.getElementById("catalog").innerHTML='<div class="empty">Error cargando cat√°logo</div>'; }
}

function renderGrid(list){
  const grid = document.getElementById("catalog");
  grid.innerHTML = "";
  if(!list.length){ grid.innerHTML='<div class="empty">No hay resultados</div>'; return; }
  for(const it of list){
    const poster = (it.poster && String(it.poster).startsWith("http"))? it.poster : (it.poster? `https://image.tmdb.org/t/p/w500${it.poster}` : "");
    const title = it.title || it.titulo || it.name || "Sin t√≠tulo";
    const rating = it.rating || "";
    const year = it.year || "";
    let actions = "";
    if(it.terabox){
      const l = normalizeLink( (safeParseJSON(it.terabox) && Array.isArray(safeParseJSON(it.terabox)) && safeParseJSON(it.terabox)[0] && safeParseJSON(it.terabox)[0].link) ? safeParseJSON(it.terabox)[0].link : it.terabox );
      actions += `<a class="btn" href="${encodeURI(l)}" ${shouldOpenBlank(l)?'target="_blank"':''}>üé¨ Ver pel√≠cula</a>`;
    }
    if(it.season_links){
      const s = safeParseJSON(it.season_links);
      if(Array.isArray(s)){
        for(const se of s){
          if(se && se.link){ const l = normalizeLink(se.link); actions += `<a class="btn" href="${encodeURI(l)}" ${shouldOpenBlank(l)?'target="_blank"':''}>üì∫ T${se.season}</a>`; }
        }
      }
    }
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="thumb">${ poster ? `<img src="${encodeURI(poster)}" alt="${title}">` : '<div style="height:100%;display:flex;align-items:center;justify-content:center;background:#111;color:#888">Sin imagen</div>' }</div>
      <div class="content">
        <div class="title">${escapeHtml(title)}</div>
        <div class="meta">${rating ? '‚≠ê '+escapeHtml(rating):''}${year ? ' ‚Ä¢ '+escapeHtml(year):''}</div>
        <div class="actions">${actions}</div>
      </div>
    `;
    grid.appendChild(el);
  }
}
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
loadCatalog();
</script>
</body>
</html>
