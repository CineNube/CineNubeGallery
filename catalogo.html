<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CineNube Gallery</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0c0c0c;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      padding: 10px;
      text-align: center;
      font-size: 1.5em;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #222;
    }
    nav button {
      background: none;
      border: none;
      color: white;
      padding: 15px;
      cursor: pointer;
      font-size: 1em;
    }
    nav button.active {
      border-bottom: 2px solid #ff9800;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      padding: 15px;
    }
    .card {
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.03);
    }
    .poster {
      width: 100%;
      height: 240px;
      object-fit: cover;
    }
    .info {
      padding: 10px;
    }
    .title {
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 5px;
    }
    .meta {
      font-size: 0.85em;
      color: #bbb;
    }
    a {
      color: #ff9800;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <header>üé¨ CineNube Gallery</header>
  <nav>
    <button class="tab active" data-type="recientes">üî• Recientes</button>
    <button class="tab" data-type="movie">üé• Pel√≠culas</button>
    <button class="tab" data-type="series">üì∫ Series</button>
  </nav>
  <div id="content" class="grid"></div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec";
    let allData = [];

    async function loadData() {
      try {
        const res = await fetch(SHEET_URL);
        const data = await res.json();
        if (Array.isArray(data)) {
          // Ordenar por published_at (m√°s reciente primero)
          data.sort((a, b) => new Date(b.published_at) - new Date(a.published_at));
          allData = data;
          showData("recientes");
        }
      } catch (err) {
        console.error("Error cargando datos:", err);
      }
    }

    function showData(type) {
      const container = document.getElementById("content");
      container.innerHTML = "";
      const now = new Date();
      let filtered = [];

      if (type === "recientes") {
        // Mostrar solo lo de las √∫ltimas 24 horas
        filtered = allData.filter(item => {
          const pubDate = new Date(item.published_at);
          return (now - pubDate) / (1000 * 60 * 60) <= 24;
        });
      } else if (type === "movie") {
        filtered = allData.filter(item => String(item.type).toLowerCase() === "movie");
      } else if (type === "series") {
        filtered = allData.filter(item => String(item.type).toLowerCase() === "series");
      } else {
        filtered = allData;
      }

      if (filtered.length === 0) {
        container.innerHTML = "<p>No hay resultados</p>";
        return;
      }

      filtered.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";

        const poster = item.poster || "https://via.placeholder.com/300x450?text=Sin+Imagen";
        const title = item.title || "Sin t√≠tulo";
        const rating = item.rating || "N/A";
        const year = item.year ? "üìÖ " + item.year : "";
        const overview = item.overview ? item.overview.substring(0, 100) + "..." : "";

        let link = "#";
        if (item.type === "movie" && item.terabox) {
          try {
            const parsed = JSON.parse(item.terabox);
            if (Array.isArray(parsed) && parsed[0].link) link = parsed[0].link;
          } catch {
            link = item.terabox;
          }
        } else if (item.type === "series" && item.season_links) {
          try {
            const seasons = JSON.parse(item.season_links);
            const first = seasons.find(s => s.link);
            if (first) link = first.link;
          } catch {}
        }

        card.innerHTML = `
          <img src="${poster}" alt="${title}" class="poster">
          <div class="info">
            <div class="title">${title}</div>
            <div class="meta">‚≠êÔ∏è ${rating} ${year}</div>
            <a href="${link}" target="_blank">Ver</a>
          </div>
        `;
        container.appendChild(card);
      });
    }

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        showData(btn.dataset.type);
      });
    });

    loadData();
  </script>
</body>
</html>
