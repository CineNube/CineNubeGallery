<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cat√°logo | CineNube</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background:#0e0e0e; color:#fff; margin:0; }
  header { background:#1c1c1c; padding:15px; text-align:center; font-size:24px; color:#00aaff; font-weight:bold; }
  #catalog { display:grid; gap:15px; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); padding:20px; }
  .item { background:#1a1a1a; border-radius:10px; overflow:hidden; text-align:center; transition:transform 0.2s; display:flex;flex-direction:column;height:420px; }
  .item:hover { transform:scale(1.05); }
  .item img { width:100%; height:260px; object-fit:cover; border-bottom:3px solid #00aaff }
  .content { padding:10px; display:flex; flex-direction:column; flex:1; }
  h3 { margin:0 0 6px 0; font-size:17px; color:#00aaff; }
  p { font-size:14px; color:#ccc; flex:1; margin:0 0 8px 0; overflow:hidden; }
  .meta { color:#9aaebf; font-size:13px; margin-bottom:8px; }
  .btn { display:inline-block; background:#00aaff; padding:7px 10px; margin:4px 3px; color:white; border-radius:7px; text-decoration:none; font-weight:700; font-size:14px; }
  .empty{padding:40px;text-align:center;color:#aaa}
</style>
</head>
<body>

<header>Cat√°logo CineNube</header>
<div id="catalog"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec';

function safeParseJSON(s){ try{return JSON.parse(s);}catch(e){return null;} }
function parseDate(item){ const c=[item.published_at,item.updated,item.updated_at,item.year]; for(const x of c){ if(!x) continue; const t=Date.parse(x); if(!isNaN(t)) return t; } return null; }
function normalizeLink(raw){ if(!raw) return '#'; const s=String(raw).trim(); if(s.startsWith('http')) return s; if(s==='#')return'#'; return 'https://cinenube.github.io/CineNubeGallery/'+s.replace(/^\/+/,'');}
function shouldBlank(url){ try{ return new URL(url).hostname!==location.hostname; }catch(e){return false;} }
function escapeHtml(s){ return s ? s.replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

async function loadCatalog(){
  const res = await fetch(SHEET_URL);
  const data = await res.json();
  const list = data.map(d=>({...d, _ts:parseDate(d)}));
  list.sort((a,b)=>(b._ts||0)-(a._ts||0));
  render(list);
}

function render(list){
  const c = document.getElementById('catalog');
  c.innerHTML='';
  if(!list.length){ c.innerHTML='<div class="empty">No hay resultados</div>'; return; }

  list.forEach(it=>{
    const title = escapeHtml(it.title||it.name||'Sin t√≠tulo');
    const poster = it.poster||it.imagen||'';
    const urlPoster = poster.startsWith('http') ? poster : (poster? 'https://image.tmdb.org/t/p/w500'+poster:'');
    const overview = escapeHtml(it.overview||it.descripcion||'');
    const rating = it.rating ? '‚≠ê '+escapeHtml(it.rating):'‚≠êÔ∏è N/A';
    const year = it.year ? ' ‚Ä¢ '+escapeHtml(it.year):'';

    let buttons='';

    // Pel√≠cula
    if(it.terabox){
      const p = safeParseJSON(it.terabox);
      let link='#';
      if(Array.isArray(p)&&p[0]?.link) link = p[0].link;
      else {
        const m=(it.terabox||'').match(/https?:\/\/\S+/);
        link = m?m[0]:it.terabox;
      }
      link = normalizeLink(link);
      const blank=shouldBlank(link)?' target="_blank"':'';
      buttons+=`<a class="btn" href="${link}"${blank}>üé• Ver pel√≠cula</a>`;
    }

    // Series ‚Üí 1 bot√≥n por temporada
    if(it.season_links){
      const s = safeParseJSON(it.season_links);
      if(Array.isArray(s)){
        s.forEach(se=>{
          if(se?.link){
            const link=normalizeLink(se.link);
            const blank=shouldBlank(link)?' target="_blank"':'';
            buttons+=`<a class="btn" href="${link}"${blank}>üì∫ T${se.season}</a>`;
          }
        });
      }
    }

    c.innerHTML+=`
    <div class="item">
      <img src="${urlPoster}" alt="${title}">
      <div class="content">
        <h3>${title}</h3>
        <p class="meta">${rating}${year}</p>
        <p>${overview}</p>
        <div style="margin-top:auto">${buttons}</div>
      </div>
    </div>`;
  });
}

loadCatalog();
</script>

</body>
</html>
