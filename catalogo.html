const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec"; // Cambia por tu WebApp URL

let items = [];

async function fetchItems() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    // Orden descendente: lo mÃ¡s nuevo/actualizado primero
    items = data.sort((a,b) => b.published_ts - a.published_ts);
    renderItems();
  } catch (err) {
    document.getElementById("catalogo").innerHTML = "<p>Error al cargar los tÃ­tulos</p>";
    console.error(err);
  }
}

function renderItems() {
  const container = document.getElementById("catalogo");
  const searchText = document.getElementById("searchBox").value.toLowerCase();
  const activeType = document.querySelector(".filter-btn.active")?.dataset.type || "all";

  container.innerHTML = "";

  items.forEach(item => {
    if (activeType !== "all" && item.type !== activeType) return;
    if (searchText && !item.title.toLowerCase().includes(searchText)) return;

    const div = document.createElement("div");
    div.classList.add("item");

    // Botones de temporadas (series)
    let seasonsHTML = "";
    if (item.type === "series" && item.season_links && item.season_links.length) {
      seasonsHTML = item.season_links.map(s => 
        `<a href="${s.link}" target="_blank" class="season-btn">Temporada ${s.season}</a>`
      ).join(" ");
    }

    // BotÃ³n â€œVer ahoraâ€ (pelÃ­culas)
    let movieButton = "";
    if (item.type === "movie" && item.terabox) {
      movieButton = `<a href="${item.terabox}" target="_blank" class="movie-btn">Ver ahora</a>`;
    }

    div.innerHTML = `
      <img src="${item.poster}" alt="${item.title}">
      <h2>${item.title}</h2>
      <p>${item.overview}</p>
      <p>â­ ${item.rating || "N/A"} | ğŸ“… ${item.year || ""}</p>
      <p>ğŸ‘ ${item.votes_up || 0} | ğŸ‘ ${item.votes_down || 0}</p>
      <div class="buttons">
        ${movieButton}
        ${seasonsHTML}
      </div>
    `;

    container.appendChild(div);
  });
}

// Filtros
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderItems();
  });
});

// Buscador
document.getElementById("searchBox").addEventListener("input", renderItems);

// Carga inicial
fetchItems();
