<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CineNube</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #0e0e0e; color: #eee; margin: 0; padding: 0; min-height:100vh; }
  header { text-align: center; padding: 2rem; background: #1c1c1c; }
  h1 { margin: 0; font-size: 2.3rem; color: #ff6600; }
  nav { text-align: center; margin: 1rem 0; }
  nav button { margin: 0 0.4rem; padding: 0.5rem 1.2rem; cursor: pointer; background: #333; color: #eee; border: none; border-radius: 8px; font-size: 0.95rem; transition: 0.2s; }
  nav button.active, nav button:hover { background: #ff6600; color: #111; }

  .search-container { text-align: center; margin: 1.5rem 0; }
  .search-container input { width: 80%; max-width: 400px; padding: 0.6rem; border-radius: 6px; border: none; outline: none; font-size: 1rem; }

  section { display: flex; flex-wrap: wrap; justify-content: center; padding: 1rem; min-height: 60vh; }
  .item { background: #1b1b1b; border-radius: 10px; margin: 1rem; width: 200px; text-align: center; box-shadow: 0 0 10px #000; transition: transform 0.2s; overflow: hidden; position: relative; cursor:pointer;}
  .item:hover { transform: scale(1.03); }

  .item img { width: 100%; height: 300px; object-fit: cover; display: block; border-radius: 10px 10px 0 0; }
  .item h3 { margin: 0.5rem 0; font-size: 1.05rem; padding: 0 0.5rem; }
  .item .meta { font-size: 0.85rem; color: #bbb; margin-bottom: 0.5rem; }
  .item .overview { font-size: 0.85rem; color: #ccc; margin: 0.5rem; }
  .item .overview.collapsed { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor:pointer; }
  .item a, .item button { display: inline-block; margin: 0.3rem 0.2rem 0.8rem 0.2rem; padding: 0.45rem 0.7rem; background: #ff6600; color: #111; text-decoration: none; border-radius: 5px; font-weight: 600; border: none; cursor: pointer; }
  .small-link { background: #444; color: #eee; padding: 0.25rem 0.4rem; border-radius: 4px; font-size:0.85rem;}
  .hidden { display: none; }
  .message { text-align: center; color: #888; padding: 2rem; width:100%; }

  .badge-new { position: absolute; top: 8px; left: 8px; background: #2ecc71; color: #111; font-weight: bold; padding: 3px 6px; border-radius: 6px; font-size: 0.75rem; }
  .badge-rating { position: absolute; top: 8px; right: 8px; padding: 3px 6px; border-radius: 6px; font-size: 0.75rem; font-weight:bold; }
  .badge-rating.high { background: #2ecc71; color: #111; }
  .badge-rating.medium { background: #f39c12; color: #111; }
  .badge-rating.low { background: #e74c3c; color: #fff; }

  /* Carrusel de recientes */
  #recentCarousel { display:flex; overflow-x:auto; padding:1rem; margin-bottom:1rem; }
  #recentCarousel .item { flex:0 0 auto; width:180px; margin-right:1rem; }

  /* Modal de donaci√≥n */
  .modal-backdrop { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .modal { background:#111; padding:1.2rem; border-radius:8px; max-width:520px; width:95%; color:#eee; box-shadow:0 6px 30px rgba(0,0,0,0.7); }
  .modal h3 { margin:0 0 0.5rem 0; color:#ffb86b; }
  .modal p { margin:0.3rem 0 1rem 0; color:#ddd; }
  .modal .actions { text-align:right; margin-top:1rem; }
  .modal .actions button { margin-left:0.5rem; }

  /* Destacado item desde hash */
  .highlighted { outline: 3px solid #ff6600; animation: pulse 1s infinite alternate; }
  @keyframes pulse { from { box-shadow: 0 0 5px #ff6600; } to { box-shadow: 0 0 15px #ff6600; } }
</style>
</head>
<body>

<header>
  <h1>CineNube</h1>
</header>

<nav>
  <button data-filter="movies" class="active">Pel√≠culas</button>
  <button data-filter="series">Series</button>
  <button data-filter="recent">Recientes</button>
</nav>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Buscar t√≠tulo, a√±o o palabra clave...">
</div>

<section id="recentCarousel" class="hidden"></section>
<section id="gallery">
  <p class="message">Cargando cat√°logo...</p>
</section>

<!-- Modal de donaci√≥n / confirmaci√≥n -->
<div id="donateModal" class="hidden" aria-hidden="true">
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Donar para desbloquear</h3>
      <p id="modalText">Para ver el enlace, haz una donaci√≥n (cantidad libre) en PayPal y luego pulsa "He donado".</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <a id="paypalLink" href="https://paypal.me/CineNubes" target="_blank" rel="noopener" style="background:#0070ba;color:#fff;padding:0.5rem 0.8rem;border-radius:6px;text-decoration:none;font-weight:700;">Ir a PayPal</a>
        <button id="confirmPaid" style="background:#2ecc71;">He donado (confirmar)</button>
        <button id="cancelModal" style="background:#aaa;color:#111;">Cancelar</button>
      </div>
      <div class="actions" style="margin-top:10px;">
        <small style="color:#bbb;">Sugerencia: dona lo que quieras, 0.10 ‚Ç¨ es v√°lido si quieres probar.</small>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const SHEET_URL = "https://api.sheetbest.com/sheets/4b4d9aed-b6a1-414d-a2d4-5c7605b85501";
const TMDB_API_KEY = "73ec36a1669f06f8684c4d104861d52b";
const PAYPAL_ME = "https://paypal.me/CineNubes";
/* ============================ */

const gallery = document.getElementById('gallery');
const recentCarousel = document.getElementById('recentCarousel');
const searchInput = document.getElementById('searchInput');
let catalogo = [];

// modal elements
const donateModal = document.getElementById('donateModal');
const modalBackdrop = document.getElementById('modalBackdrop');
const paypalLink = document.getElementById('paypalLink');
const confirmPaid = document.getElementById('confirmPaid');
const cancelModal = document.getElementById('cancelModal');
const modalTitle = document.getElementById('modalTitle');
const modalText = document.getElementById('modalText');

paypalLink.href = PAYPAL_ME;

function parseFecha(fechaStr) {
  if (!fechaStr) return null;
  if (typeof fechaStr !== 'string') return null;
  const partes = fechaStr.split("-");
  if (partes.length === 3 && partes[0].length<=2) {
    const [d,m,y] = partes.map(p=>parseInt(p,10));
    if (!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y,m-1,d);
  }
  const dt = new Date(fechaStr);
  return isNaN(dt.getTime()) ? null : dt;
}

function storageKeyFor(item, suffix='') {
  const base = item.TMDB_ID ? String(item.TMDB_ID) : (item.id || item.title || 'item');
  const safe = base.toString().replace(/[^a-zA-Z0-9_\-]/g,'_');
  return `cinenube_unlocked_${safe}${suffix}`;
}

function unlockAndOpen(key, url) {
  try { localStorage.setItem(key, '1'); } catch(e){ }
  if(url) window.open(url, '_blank');
}

function showDonateModal({title, hint, onConfirm}) {
  modalTitle.textContent = `Donar para desbloquear: ${title}`;
  modalText.textContent = hint || 'Para ver el enlace, haz una donaci√≥n (cantidad libre) en PayPal y luego pulsa "He donado".';
  paypalLink.href = PAYPAL_ME;
  donateModal.classList.remove('hidden');
  donateModal.setAttribute('aria-hidden','false');

  confirmPaid.onclick = () => {
    donateModal.classList.add('hidden');
    donateModal.setAttribute('aria-hidden','true');
    if (typeof onConfirm === 'function') onConfirm();
  };
  cancelModal.onclick = () => {
    donateModal.classList.add('hidden');
    donateModal.setAttribute('aria-hidden','true');
  };
  modalBackdrop.onclick = (e) => {
    if (e.target === modalBackdrop) {
      donateModal.classList.add('hidden');
      donateModal.setAttribute('aria-hidden','true');
    }
  };
}

// crea tarjeta DOM (con paywall)
function createItemCard(item, isCarousel=false) {
  const hoy = new Date();
  const div = document.createElement('div');
  div.className = 'item';
  div.dataset.tmdbId = item.TMDB_ID || '';

  const imgUrl = (item.last_episode_still || item.poster) || 'https://via.placeholder.com/200x300?text=Sin+Imagen';
  const img = document.createElement('img');
  img.src = imgUrl;
  img.alt = item.title || 'Sin t√≠tulo';
  img.loading = 'lazy';

  const h3 = document.createElement('h3');
  h3.textContent = item.title || 'Sin t√≠tulo';

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = (item.year ? item.year + ' ¬∑ ' : '') + (item.type === 'movie' ? 'Pel√≠cula' : 'Serie');

  const resumen = document.createElement('div');
  resumen.className = 'overview collapsed';
  const texto = (item.last_episode_overview || item.overview || '').trim();
  resumen.textContent = texto.length > 120 ? texto.slice(0,120) + '...' : texto;
  resumen.onclick = () => {
    resumen.classList.toggle('collapsed');
    resumen.textContent = resumen.classList.contains('collapsed') ? (texto.length>120 ? texto.slice(0,120)+'...' : texto) : texto;
  };

  let fechaNuevo = parseFecha(item.updated || item.added);
  if (item.type === 'series' && item.last_episode_air_date) {
    const epDate = parseFecha(item.last_episode_air_date);
    if (epDate) fechaNuevo = epDate;
  }
  if (fechaNuevo && ((hoy - fechaNuevo) / (1000*60*60*24)) <= 3) {
    const badge = document.createElement('div');
    badge.className = 'badge-new';
    badge.textContent = 'üü¢ Nuevo';
    div.appendChild(badge);
  }

  if (item.rating) {
    const b = document.createElement('div');
    b.className = 'badge-rating ' + (item.rating >= 7 ? 'high' : (item.rating >= 5 ? 'medium' : 'low'));
    b.textContent = Number(item.rating).toFixed(1);
    div.appendChild(b);
  }

  div.appendChild(img);
  div.appendChild(h3);
  div.appendChild(meta);
  div.appendChild(resumen);

  function makeDonateButton(label, unlockKey, targetUrl) {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.onclick = (e) => {
      e.stopPropagation();
      if (localStorage.getItem(unlockKey)) {
        if (targetUrl) window.open(targetUrl, '_blank');
        return;
      }
      showDonateModal({
        title: item.title,
        hint: `Haz una donaci√≥n (cantidad libre) en PayPal. Pulsa "Ir a PayPal", realiza la donaci√≥n y luego vuelve aqu√≠ y pulsa "He donado".`,
        onConfirm: () => {
          unlockAndOpen(unlockKey, targetUrl);
        }
      });
      window.open(PAYPAL_ME, '_blank');
    };
    return btn;
  }

  if (item.type === 'movie') {
    const key = storageKeyFor(item,'_movie');
    if (item.terabox) {
      const btn = makeDonateButton('Donar y ver', key, item.terabox);
      div.appendChild(btn);
    }
  }

  if (item.type === 'series' && item.season_links) {
    try {
      const seasons = JSON.parse(item.season_links);
      seasons.forEach(s => {
        const key = storageKeyFor(item,`_S${s.season}`);
        const label = `Temporada ${s.season}`;
        if (s.link) {
          const btn = makeDonateButton(label, key, s.link);
          btn.className = 'small-link';
          div.appendChild(btn);
        } else {
          const disabled = document.createElement('button');
          disabled.textContent = label;
          disabled.disabled = true;
          disabled.style.background = '#555';
          div.appendChild(disabled);
        }
      });
    } catch(e) { console.error("Error en season_links", e); }
  }

  return div;
}

// mostrar items
async function showItems(filter, query='') {
  gallery.innerHTML = '';
  const hoy = new Date();
  const normalize = s => (s||'').toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  let items = catalogo.filter(i => {
    if (filter === 'movies') return i.type === 'movie';
    if (filter === 'series') return i.type === 'series';
    if (filter === 'recent') {
      const fecha = parseFecha(i.updated || i.added);
      if (!fecha) return false;
      const diasDiff = (hoy - fecha) / (1000*60*60*24);
      return diasDiff <= 1*1;
    }
    return true;
  });

  if (query) {
    const nq = normalize(query);
    items = items.filter(i =>
      normalize(i.title).includes(nq) ||
      normalize(i.overview).includes(nq) ||
      (i.year && i.year.toString().includes(nq))
    );
  }

  if (!items.length) {
    gallery.innerHTML = '<p class="message">No se encontr√≥ contenido.</p>';
    return;
  }

  items.sort((a,b)=> {
    const fa = parseFecha(a.updated || a.added) || new Date(0);
    const fb = parseFecha(b.updated || b.added) || new Date(0);
    return fb - fa;
  });

  items.forEach(item => {
    const card = createItemCard(item);
    gallery.appendChild(card);
  });

  // scroll autom√°tico si hay hash
  const hashId = window.location.hash.slice(1);
  if (hashId) {
    const target = Array.from(gallery.children).find(c=>c.dataset.tmdbId===hashId);
    if (target) {
      target.scrollIntoView({behavior:'smooth', block:'center'});
      target.classList.add('highlighted');
      setTimeout(()=> target.classList.remove('highlighted'), 5000);
    }
  }
}

/* ========== EVENTOS ========== */
document.querySelectorAll('nav button').forEach(b => {
  b.addEventListener('click', e => {
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    showItems(b.dataset.filter, searchInput.value);
  });
});

searchInput.addEventListener('input', e => {
  const active = document.querySelector('nav button.active').dataset.filter;
  showItems(active, e.target.value);
});

/* ========== CARGA DE DATOS ========== */
async function cargarCatalogo() {
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    catalogo = data.map(row => ({
      TMDB_ID: row.TMDB_ID,
      title: row.T√≠tulo,
      overview: row.Descripci√≥n,
      last_episode_overview: row.Descripci√≥nCap,
      last_episode_still: row.ImagenCap,
      poster: row.Imagen,
      year: row.A√±o,
      type: row.Tipo,
      updated: row.Actualizado,
      added: row.Agregado,
      rating: parseFloat(row.Rating) || 0,
      terabox: row.Terabox,
      season_links: row.Temporadas || ''
    }));
    showItems('movies');
  } catch(e) {
    console.error(e);
    gallery.innerHTML = '<p class="message">Error al cargar cat√°logo. Intenta recargar.</p>';
  }
}

cargarCatalogo();
</script>
</body>
</html>
