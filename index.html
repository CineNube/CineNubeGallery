<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CineNube Gallery</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;background:#0e0e0e;color:#fff;margin:0;padding:0;overflow-x:hidden}
  header{background:#1c1c1c;padding:18px;text-align:center;font-size:24px;font-weight:700;color:#00aaff;box-shadow:0 0 8px rgba(0,0,0,.5)}
  nav{display:flex;justify-content:center;gap:14px;background:#141414;padding:10px 8px;font-weight:700;flex-wrap:wrap}
  nav button{background:none;border:1px solid transparent;color:#fff;cursor:pointer;font-size:15px;padding:6px 10px;border-radius:6px;transition:all .18s}
  nav button.active{border-color:rgba(0,170,255,.18);background:rgba(0,170,255,.03);color:#00aaff}
  nav button:hover{color:#00aaff}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:18px}
  .item{background:#141414;border-radius:12px;overflow:hidden;text-align:left;box-shadow:0 0 10px rgba(0,0,0,0.6);transition:transform .18s,box-shadow .18s;position:relative;display:flex;flex-direction:column;height:460px}
  .item:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,170,255,.08)}
  .thumb{height:300px;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;border-bottom:3px solid #00aaff}
  .content{padding:10px 12px;display:flex;flex-direction:column;flex:1}
  .title{color:#00aaff;font-size:16px;margin:6px 0 4px;height:40px;overflow:hidden}
  .overview{font-size:13px;color:#ccc;line-height:1.2;height:66px;overflow:hidden;margin-bottom:8px}
  .btn{margin-top:auto;display:inline-block;background:#00aaff;color:#fff;text-decoration:none;padding:10px;border-radius:6px;font-weight:700;text-align:center;margin:2px 2px 0 0}
  .empty{padding:40px;text-align:center;color:#aaa}
  .tag{position:absolute;top:12px;left:12px;background:#00aaff;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  .new{position:absolute;top:12px;right:12px;background:#ff2d55;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  @media(max-width:700px){.item{height:420px}.thumb{height:260px}}
</style>
</head>
<body>
<header>üé¨ CineNube Gallery</header>
<nav id="nav">
  <button data-filter="all" class="active">üîÅ Todos</button>
  <button data-filter="recientes">üî• Recientes (24h)</button>
  <button data-filter="movie">üé• Pel√≠culas</button>
  <button data-filter="series">üì∫ Series</button>
</nav>

<div id="gallery"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec';
let allData = [];

function safeParseJSON(s){ try { return JSON.parse(s.replace(/'/g,'"')); } catch(e){ return null; } }
function normalizeLink(raw){ if(!raw) return '#'; const s=String(raw).trim(); if(s.startsWith('http')) return s; if(s==='#') return '#'; return 'https://cinenube.github.io/CineNubeGallery/' + s.replace(/^\/+/,''); }
function shouldOpenBlank(url){ try{ const u=new URL(url); return u.hostname !== location.hostname; }catch(e){ return false; }

}

function normalizeItem(raw){
  var it = {};
  it.title = raw.title || raw.titulo || raw.name || '';
  it.poster = raw.poster || raw.imagen || '';
  it.overview = raw.overview || raw.descripcion || '';
  it.type = (function(t){ if(!t) return 'movie'; var s=String(t).toLowerCase(); if(s==='tv' || s==='series' || s==='serie') return 'series'; return 'movie'; })(raw.type || raw.tipo);
  it.terabox = raw.terabox || raw.link || '';
  it.season_links = raw.season_links || raw.seasons || '';
  it.published_ts = raw.published_at ? Date.parse(raw.published_at) : null;
  return it;
}

function getFirstLink(it){
  if(it.terabox){
    const p = safeParseJSON(it.terabox);
    if(Array.isArray(p) && p[0] && p[0].link) return p[0].link;
    const m = (it.terabox||'').toString().match(/https?:\/\/[^\s"']+/);
    if(m) return m[0];
    if(String(it.terabox).trim()) return String(it.terabox).trim();
  }
  if(it.season_links){
    const s = (typeof it.season_links==='string')?safeParseJSON(it.season_links):it.season_links;
    if(Array.isArray(s) && s[0] && s[0].link) return s[0].link;
    const mm = (it.season_links||'').toString().match(/https?:\/\/[^\s"']+/);
    if(mm) return mm[0];
    if(String(it.season_links).trim()) return String(it.season_links).trim();
  }
  return '#';
}

function getSeasonButtonsHtml(item){
  if(!item.season_links) return '';
  const parsed = (typeof item.season_links==='string')?safeParseJSON(item.season_links):item.season_links;
  if(!Array.isArray(parsed)) return '';
  let html = '';
  parsed.forEach(s=>{
    if(s && s.link){
      const link = normalizeLink(s.link);
      const blank = shouldOpenBlank(link)?' target="_blank':'';
      html += `<a class="btn" href="${link}"${blank}>üì∫ T${s.season}</a>`;
    }
  });
  return html;
}

async function loadGallery(){
  try{
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    if(!Array.isArray(data)){ document.getElementById('gallery').innerHTML='<div class="empty">Respuesta inv√°lida del WebApp.</div>'; return; }
    allData = data.map(normalizeItem);
    renderGallery(allData);
  }catch(e){
    console.error(e);
    document.getElementById('gallery').innerHTML='<div class="empty">Error cargando datos</div>';
  }
}

function renderGallery(list){
  const g = document.getElementById('gallery');
  g.innerHTML='';
  if(!list||list.length===0){ g.innerHTML='<div class="empty">No hay resultados</div>'; return; }

  list.forEach(it=>{
    const tipoTexto = it.type==='series'?'üì∫ Serie':'üé• Pel√≠cula';
    const posterUrl = (it.poster && it.poster.indexOf('http')===0)?it.poster:(it.poster?'https://image.tmdb.org/t/p/w500'+it.poster:'');
    const title = it.title;
    const overview = it.overview;

    const primary = normalizeLink(getFirstLink(it));
    const blank = shouldOpenBlank(primary)?' target="_blank':'';

    const seasonButtons = getSeasonButtonsHtml(it);

    const div = document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div class="thumb"><img src="${encodeURI(posterUrl||'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22900%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23111%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%23aaa%22 font-size=%2220%22 font-family=%22Arial%22 text-anchor=%22middle%22>Sin imagen</text></svg>')}" alt="${title}"></div>
      <div class="content">
        <div class="title">${title}</div>
        <div class="overview">${overview}</div>
        <a class="btn" href="${primary}"${blank}>${it.type==='series'?'üì∫ Ver temporada':'üé¨ Ver pel√≠cula'}</a>
        <div style="margin-top:6px">${seasonButtons}</div>
      </div>
      <span class="tag">${tipoTexto}</span>
    `;
    g.appendChild(div);
  });
}

document.getElementById('nav').addEventListener('click',function(e){
  const btn = e.target.closest('button[data-filter]');
  if(!btn) return;
  const filter = btn.getAttribute('data-filter');
  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  if(filter==='all') renderGallery(allData);
  else if(filter==='recientes') renderGallery(allData.filter(i=>i.published_ts && ((Date.now()-i.published_ts)<=1000*60*60*24)));
  else renderGallery(allData.filter(i=>i.type===filter));
});

loadGallery();
</script>
</body>
</html>
