<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé¨ CineNube Gallery</title>
<style>
body{margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;background:#141414;color:#fff;}
header{background:#e50914;padding:20px;text-align:center;font-size:2em;font-weight:bold;color:white;letter-spacing:1px;}
.topbar{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;padding:10px;background:#1f1f1f;}
.search{padding:8px 12px;border-radius:6px;border:none;width:320px;max-width:90%;font-size:1em;}
nav{display:flex;justify-content:center;gap:12px;padding:12px;background:#1f1f1f;flex-wrap:wrap;}
nav button{background:none;border:1px solid transparent;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:700;transition:.2s;}
nav button.active, nav button:hover{background:#e50914;border-color:#fff;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;padding:20px;}
.item{background:#1e1e1e;border-radius:10px;overflow:hidden;transition:transform .2s,box-shadow .2s;display:flex;flex-direction:column;height:auto;position:relative;}
.item:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,.8);}
.thumb{height:300px;overflow:hidden;}
.thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.content{padding:10px;display:flex;flex-direction:column;flex:1;}
.title{font-size:1em;font-weight:bold;color:#e50914;margin:6px 0 4px;overflow:hidden;height:40px;}
.overview{font-size:0.85em;color:#ccc;line-height:1.2;height:66px;overflow:hidden;margin-bottom:8px;}
.meta{font-size:0.8em;color:#999;margin-bottom:6px;}
.btn{margin-top:3px;display:block;background:#e50914;color:#fff;text-decoration:none;padding:8px;border-radius:6px;font-weight:700;text-align:center;font-size:0.9em;}
.btn.disabled{background:#333;cursor:default;}
.btn-season{margin:3px 3px 0 0;background:#ff2d55;color:#fff;padding:4px 6px;border-radius:5px;font-size:0.8em;display:inline-block;text-decoration:none;}
.tag{position:absolute;top:12px;left:12px;background:#141414;color:#e50914;padding:4px 8px;border-radius:6px;font-size:0.75em;font-weight:700;}
.new{position:absolute;top:12px;right:12px;background:#ff2d55;color:#fff;padding:4px 8px;border-radius:6px;font-size:0.75em;font-weight:700;}
</style>
</head>
<body>
<header>üé¨ CineNube Gallery</header>
<div class="topbar">
  <input id="search" class="search" placeholder="Buscar t√≠tulo, g√©nero, a√±o..." />
</div>
<nav>
  <button data-filter="all" class="active">Todos</button>
  <button data-filter="movie">Pel√≠culas</button>
  <button data-filter="series">Series</button>
</nav>
<div class="grid" id="catalog">Cargando cat√°logo...</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx1Vq5HqmPMExtgm1PRgct2WRzGex5BTEtDERIKHA20VZNFf-umdHpiKD94Df80S2vO1g/exec";

let allItems = [];
let filteredItems = [];

// Parse robusto de season_links
function parseSeasons(seasonData){
  let seasons = [];
  if(!seasonData) return seasons;
  try{
    let s = seasonData.toString().trim();
    // eliminar dobles comillas externas
    if(s.startsWith('"') && s.endsWith('"')) s = s.slice(1,-1);
    // eliminar doble corchete externo [[ ... ]]
    if(s.startsWith('[[') && s.endsWith(']]')) s = s.slice(1,-1);
    // limpiar escapes de comillas
    s = s.replace(/\\"/g,'"');
    seasons = JSON.parse(s);
    if(!Array.isArray(seasons)) seasons = [];
  }catch(e){ seasons = []; }
  return seasons;
}

async function fetchItems(){
  try{
    const res = await fetch(WEBAPP_URL);
    let data = await res.json();
    allItems = data.sort((a,b)=>b.published_ts - a.published_ts);
    filteredItems = allItems.slice();
    renderCatalog(filteredItems);
  }catch(err){
    console.error("Error cargando cat√°logo:",err);
    document.getElementById('catalog').innerHTML='<p style="text-align:center;color:#aaa;">Error cargando cat√°logo</p>';
  }
}

function renderCatalog(list){
  const now = Date.now();
  const catalog = document.getElementById('catalog');
  catalog.innerHTML='';
  if(!list.length){ catalog.innerHTML='<p style="text-align:center;color:#aaa;">No hay resultados</p>'; return; }

  list.forEach(it=>{
    const isNew=(now-it.published_ts)<=(1000*60*60*24*7);
    const div=document.createElement('div');
    div.className='item';

    let contentHTML = `
      <div class="thumb"><img src="${it.poster}" alt="${it.title}"></div>
      <div class="content">
        <div class="title">${it.title}</div>
        <div class="overview">${it.overview||''}</div>
        <div class="meta">${it.rating?'‚≠ê '+it.rating:''} ${it.year? '| '+it.year:''}</div>
    `;

    if(it.type==='series'){
      const seasons = parseSeasons(it.season_links);
      let seasonButtons = '';
      seasons.forEach(s=>{
        if(s && s.link && s.link.trim()!==''){
          seasonButtons += `<a class="btn btn-season" href="${s.link}" target="_blank">Temporada ${s.season}</a>`;
        }
      });
      if(!seasonButtons) seasonButtons='<span class="btn disabled">Sin temporadas disponibles</span>';
      contentHTML += seasonButtons;
    } else if(it.type==='movie'){
      const primary = it.terabox||'#';
      contentHTML += `<a class="btn ${primary==='#'?'disabled':''}" href="${primary}" target="_blank">üé• Ver Pel√≠cula</a>`;
    }

    contentHTML += '</div>';
    div.innerHTML = contentHTML;
    div.innerHTML += `<span class="tag">${it.type==='series'?'Series':'Pel√≠cula'}</span>${isNew?'<span class="new">üÜï Nuevo</span>':''}`;
    catalog.appendChild(div);
  });
}

function applyFilters(){
  const q=document.getElementById('search').value.toLowerCase();
  const activeBtn=document.querySelector('nav button.active');
  const filter=activeBtn?activeBtn.getAttribute('data-filter'):'all';
  filteredItems=allItems.filter(it=>{
    if(filter==='movie' && it.type!=='movie') return false;
    if(filter==='series' && it.type!=='series') return false;
    if(!q) return true;
    const hay=(it.title+' '+it.overview+' '+(it.generos||'')+' '+it.year).toLowerCase();
    return q.split(' ').every(tok=>hay.includes(tok));
  });
  renderCatalog(filteredItems);
}

document.querySelectorAll('nav button').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    applyFilters();
  });
});

document.getElementById('search').addEventListener('input',()=>{ applyFilters(); });

fetchItems();
</script>
</body>
</html>
