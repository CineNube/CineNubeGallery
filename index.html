<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CineNube Gallery</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;background:#0e0e0e;color:#fff;margin:0;padding:0;overflow-x:hidden}
  header{background:#1c1c1c;padding:18px;text-align:center;font-size:24px;font-weight:700;color:#00aaff;box-shadow:0 0 8px rgba(0,0,0,.5)}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:center;padding:10px;background:#141414;flex-wrap:wrap}
  .search { width:320px; max-width:80%; padding:8px 12px;border-radius:8px;border:1px solid #2b2b2b;background:#0f0f0f;color:#fff }
  nav{display:flex;justify-content:center;gap:14px;background:#141414;padding:10px 8px;font-weight:700;flex-wrap:wrap}
  nav button{background:none;border:1px solid transparent;color:#fff;cursor:pointer;font-size:15px;padding:6px 10px;border-radius:6px;transition:all .18s}
  nav button.active{border-color:rgba(0,170,255,.18);background:rgba(0,170,255,.03);color:#00aaff}
  nav button:hover{color:#00aaff}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:18px}
  .item{background:#141414;border-radius:12px;overflow:hidden;text-align:left;box-shadow:0 0 10px rgba(0,0,0,0.6);transition:transform .18s,box-shadow .18s;position:relative;display:flex;flex-direction:column;height:460px}
  .item:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,170,255,.08)}
  .thumb{height:300px;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;border-bottom:3px solid #00aaff}
  .content{padding:10px 12px;display:flex;flex-direction:column;flex:1}
  .title{color:#00aaff;font-size:16px;margin:6px 0 4px;height:40px;overflow:hidden}
  .overview{font-size:13px;color:#ccc;line-height:1.2;height:66px;overflow:hidden;margin-bottom:8px}
  .meta{font-size:12px;color:#99e6ff;margin-bottom:8px}
  .btn{margin-top:auto;display:block;background:#00aaff;color:#fff;text-decoration:none;padding:10px;border-radius:0 0 12px 12px;font-weight:700;text-align:center}
  .btn.disabled{background:#333;cursor:default}
  .tag{position:absolute;top:12px;left:12px;background:#00aaff;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  .new{position:absolute;top:12px;right:12px;background:#ff2d55;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  .hashtags{font-size:12px;color:#00ccff;padding:0 12px;height:28px;overflow:hidden;margin-top:6px}
  .empty{padding:40px;text-align:center;color:#aaa}
  #debugBox{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.6);color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;z-index:9999;max-width:320px}
  #debugBox b{color:#00aaff}
  @media(max-width:700px){.item{height:auto}.thumb{height:260px}}
</style>
</head>
<body>
<header>üé¨ CineNube Gallery</header>

<div class="topbar">
  <input id="search" class="search" placeholder="Buscar t√≠tulo, g√©nero, a√±o... (acentos ignorados)" />
</div>

<nav id="nav">
  <button data-filter="all" class="active">üîÅ Todos</button>
  <button data-filter="movie">üé• Pel√≠culas</button>
  <button data-filter="series">üì∫ Series</button>
</nav>

<div id="gallery"></div>

<script>
const SHEET_URL='https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec';
const SHOW_DEBUG=false;
let allData=[],filteredData=[];

function safeParseJSON(s){try{return JSON.parse(s);}catch(e){return null;}}
function escapeHtml(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';}
function normText(s){return s?String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^0-9a-zA-Z\s]/g,' ').replace(/\s+/g,' ').trim().toLowerCase():'';}

function parseDatePrefer(obj){
  if(!obj) return null;
  const c=[obj.published_at,obj.updated,obj.updated_at,obj.year];
  for(let i=0;i<c.length;i++){if(!c[i])continue;const t=Date.parse(c[i]);if(!isNaN(t))return t;}
  return null;
}

function normalizeItem(r){
  let it={};
  it.raw=r;
  it.title=r.title||r.titulo||r.name||'';
  it.poster=r.poster||r.imagen||r.poster_path||'';
  it.overview=r.overview||r.descripcion||r.description||'';
  it.rating=r.rating||r.vote_average||'';
  it.year=r.year||'';
  it.generos=r.generos||r.genres||'';
  it.type=(function(t){if(!t)return'movie';t=String(t).toLowerCase();if(['tv','series','serie'].includes(t))return'series';if(['movie','pelicula','pel√≠cula','film'].includes(t))return'movie';return t;})(r.type||r.tipo);
  it.terabox=r.terabox||r.link||r.enlace||'';
  it.season_links=r.season_links||r.seasons||r.seasonLinks||'';
  it.published_ts=parseDatePrefer(r);
  it._index=normText([it.title,it.overview,it.generos,it.year].join(' '));
  return it;
}

/* ‚úÖ Corregido: busca la primera temporada con link v√°lido */
function getFirstLink(it){
  if(it.season_links){
    const arr=typeof it.season_links==='string'?safeParseJSON(it.season_links):it.season_links;
    if(Array.isArray(arr)){
      for(let s of arr){
        if(s && s.link && s.link.trim()!=='') return s.link.trim();
      }
    }
  }
  if(it.terabox){
    try{
      const p=safeParseJSON(it.terabox);
      if(Array.isArray(p)){
        for(let s of p){if(s&&s.link&&s.link.trim()!=='')return s.link.trim();}
      }
    }catch(e){}
    const m=(it.terabox||'').toString().match(/https?:\/\/[^\s"']+/);
    if(m) return m[0];
    if(String(it.terabox).trim()) return String(it.terabox).trim();
  }
  return '#';
}

function normalizeLink(raw){
  if(!raw) return '#';
  const s=String(raw).trim();
  if(s.startsWith('http://')||s.startsWith('https://')) return s;
  if(s==='#') return '#';
  return 'https://cinenube.github.io/CineNubeGallery/'+s.replace(/^\/+/,'');
}

function getSeasonButtonsHtml(item){
  if(!item.season_links) return '';
  const parsed=safeParseJSON(item.season_links);
  if(!Array.isArray(parsed)) return '';
  let html='',hasAny=false;
  parsed.forEach(s=>{
    if(!s||typeof s.season==='undefined')return;
    const link=s.link?normalizeLink(s.link):'';
    if(link&&link!=='#'){hasAny=true;html+=` <a class="btn" href="${escapeHtml(link)}" target="_blank">üì∫ T${s.season}</a>`;}
    else html+=` <a class="btn disabled" href="javascript:void(0)">üîí T${s.season}</a>`;
  });
  return hasAny?html:'';
}

async function loadGallery(){
  const res=await fetch(SHEET_URL);
  const data=await res.json();
  allData=data.map(normalizeItem);
  allData.sort((a,b)=>(b.published_ts||0)-(a.published_ts||0));
  filteredData=allData.slice();
  renderGallery(filteredData);
}

function renderGallery(list){
  const g=document.getElementById('gallery');
  g.innerHTML='';
  if(!list||!list.length){g.innerHTML='<div class="empty">No hay resultados</div>';return;}
  const now=Date.now();
  list.forEach(it=>{
    const tipo=it.type==='series'?'series':'movie';
    const tipoTexto=tipo==='series'?'üì∫ Serie':'üé• Pel√≠cula';
    const btnText=tipo==='series'?'üì∫ Ver temporada':'üé• Ver pel√≠cula';
    const poster=(it.poster&&it.poster.indexOf('http')===0)?it.poster:'https://image.tmdb.org/t/p/w500'+(it.poster||'');
    const primary=normalizeLink(getFirstLink(it));
    const seasonHtml=getSeasonButtonsHtml(it);
    const hasPrimary=(primary&&primary!=='#')||seasonHtml.trim()!=='';
    const isNew=it.published_ts?((now-it.published_ts)<=86400000):false;

    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div class="thumb"><img src="${poster}" alt="${escapeHtml(it.title)}"></div>
      <div class="content">
        <div class="title">${escapeHtml(it.title)}</div>
        <div class="overview">${escapeHtml(it.overview)}</div>
        <div class="meta">${escapeHtml(it.year||'')}</div>
        ${hasPrimary?`<a class="btn" href="${escapeHtml(primary)}" target="_blank">${escapeHtml(btnText)}</a>`:`<a class="btn disabled" href="javascript:void(0)">Enlace no disponible</a>`}
        <div style="margin-top:8px">${seasonHtml}</div>
      </div>
      <span class="tag">${escapeHtml(tipoTexto)}</span>
      ${isNew?'<span class="new">üÜï Nuevo</span>':''}
    `;
    g.appendChild(div);
  });
}

loadGallery();
</script>
</body>
</html>
