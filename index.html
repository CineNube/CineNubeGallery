<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CineNube</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #0e0e0e; color: #eee; margin: 0; padding: 0; min-height:100vh; }
  header { text-align: center; padding: 2rem; background: #1c1c1c; }
  h1 { margin: 0; font-size: 2.3rem; color: #ff6600; }
  nav { text-align: center; margin: 1rem 0; }
  nav button { margin: 0 0.4rem; padding: 0.5rem 1.2rem; cursor: pointer; background: #333; color: #eee; border: none; border-radius: 8px; font-size: 0.95rem; transition: 0.2s; }
  nav button.active, nav button:hover { background: #ff6600; color: #111; }

  .search-container { text-align: center; margin: 1.5rem 0; }
  .search-container input { width: 80%; max-width: 400px; padding: 0.6rem; border-radius: 6px; border: none; outline: none; font-size: 1rem; }

  section { display: flex; flex-wrap: wrap; justify-content: center; padding: 1rem; min-height: 60vh; }
  .item { background: #1b1b1b; border-radius: 10px; margin: 1rem; width: 200px; text-align: center; box-shadow: 0 0 10px #000; transition: transform 0.2s; overflow: hidden; position: relative; }
  .item:hover { transform: scale(1.03); }
  .item img { width: 100%; height: 300px; object-fit: cover; display:block; }
  .item h3 { margin: 0.5rem 0; font-size: 1.05rem; padding: 0 0.5rem; }
  .item .meta { font-size: 0.85rem; color: #bbb; margin-bottom: 0.5rem; }
  .item a { display: inline-block; margin: 0.3rem 0.2rem 0.8rem 0.2rem; padding: 0.4rem 0.6rem; background: #ff6600; color: #111; text-decoration: none; border-radius: 5px; font-weight: 600; }
  .small-link { background: #444; color: #eee; padding: 0.25rem 0.4rem; border-radius: 4px; font-size:0.85rem;}
  .hidden { display: none; }
  .message { text-align: center; color: #888; padding: 2rem; width:100%; }

  .badge-new {
    position: absolute;
    top: 8px;
    left: 8px;
    background: #2ecc71;
    color: #111;
    font-weight: bold;
    padding: 3px 6px;
    border-radius: 6px;
    font-size: 0.75rem;
  }
</style>
</head>
<body>

<header>
  <h1>CineNube</h1>
</header>

<nav>
  <button data-filter="movies" class="active">Pel√≠culas</button>
  <button data-filter="series">Series</button>
  <button data-filter="recent">Recientes</button>
</nav>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Buscar t√≠tulo, a√±o o palabra clave...">
</div>

<section id="gallery">
  <p class="message">Cargando cat√°logo...</p>
</section>

<script>
// URL de tu hoja en Sheet.best
const SHEET_URL = "https://api.sheetbest.com/sheets/4b4d9aed-b6a1-414d-a2d4-5c7605b85501";
const gallery = document.getElementById('gallery');
const searchInput = document.getElementById('searchInput');
let catalogo = [];

// Funci√≥n para convertir fecha DD-MM-YYYY a formato v√°lido
function parseFecha(fechaStr) {
  if (!fechaStr) return null;
  const partes = fechaStr.split("-");
  if (partes.length === 3) {
    const [dia, mes, a√±o] = partes.map(p => parseInt(p, 10));
    return new Date(a√±o, mes - 1, dia);
  }
  return new Date(fechaStr);
}

// Mostrar √≠tems seg√∫n filtro o b√∫squeda
function showItems(filter, query = '') {
  gallery.innerHTML = '';
  const hoy = new Date();

  // Normalizar b√∫squeda (quita acentos, min√∫sculas)
  const normalize = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  let items = catalogo.filter(i => {
    if (filter === 'movies') return i.type === 'movie';
    if (filter === 'series') return i.type === 'series';
    if (filter === 'recent') {
      const fecha = parseFecha(i.updated || i.added);
      if (!fecha) return false;
      const diasDiff = (hoy - fecha) / (1000*60*60*24);
      return diasDiff <= 15; // √∫ltimos 15 d√≠as
    }
    return true;
  });

  if (query) {
    const nq = normalize(query);
    items = items.filter(i =>
      normalize(i.title || '').includes(nq) ||
      normalize(i.overview || '').includes(nq) ||
      (i.year && i.year.toString().includes(nq))
    );
  }

  if (!items.length) {
    gallery.innerHTML = '<p class="message">No se encontr√≥ contenido.</p>';
    return;
  }

  // Ordenar por fecha de actualizaci√≥n
  items.sort((a, b) => {
    const fa = parseFecha(a.updated || a.added);
    const fb = parseFecha(b.updated || b.added);
    return fb - fa;
  });

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';

    const img = document.createElement('img');
    img.src = item.poster || 'https://via.placeholder.com/200x300?text=Sin+Imagen';
    img.alt = item.title || 'Sin t√≠tulo';

    const h3 = document.createElement('h3');
    h3.textContent = item.title || 'Sin t√≠tulo';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = (item.year ? item.year + ' ¬∑ ' : '') + (item.type === 'movie' ? 'Pel√≠cula' : 'Serie');

    const resumen = document.createElement('div');
    resumen.style.fontSize = '0.85rem';
    resumen.style.color = '#ccc';
    resumen.style.margin = '0.5rem';
    const texto = (item.overview || '').trim();
    resumen.textContent = texto.length > 120 ? texto.slice(0,120) + '...' : texto;

    // Mostrar "Nuevo" si actualizado hace <3 d√≠as
    const fUpd = parseFecha(item.updated || item.added);
    if (fUpd && ((hoy - fUpd) / (1000*60*60*24)) <= 3) {
      const badge = document.createElement('div');
      badge.className = 'badge-new';
      badge.textContent = 'üü¢ Nuevo';
      div.appendChild(badge);
    }

    div.appendChild(img);
    div.appendChild(h3);
    div.appendChild(meta);
    div.appendChild(resumen);

    if (item.type === 'movie' && item.terabox) {
      const link = document.createElement('a');
      link.href = item.terabox;
      link.target = '_blank';
      link.textContent = 'Ver Pel√≠cula';
      div.appendChild(link);
    }

    if (item.type === 'series' && item.season_links) {
      try {
        const seasons = JSON.parse(item.season_links);
        seasons.forEach(s => {
          const btn = document.createElement('a');
          btn.href = s.link;
          btn.target = '_blank';
          btn.className = 'small-link';
          btn.textContent = `Temporada ${s.season}`;
          div.appendChild(btn);
        });
      } catch(e) { console.error("Error en season_links", e); }
    }

    gallery.appendChild(div);
  });
}

// Cargar cat√°logo
fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {
    catalogo = data.filter(row => row.title);
    showItems('movies');
  })
  .catch(err => {
    gallery.innerHTML = '<p class="message" style="color:tomato;">‚ùå Error cargando datos.</p>';
    console.error(err);
  });

// Filtros
const buttons = document.querySelectorAll('nav button');
buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    buttons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    showItems(btn.dataset.filter, searchInput.value);
  });
});

// Buscador
searchInput.addEventListener('input', e => {
  const filter = document.querySelector('nav button.active').dataset.filter;
  showItems(filter, e.target.value);
});
</script>

</body>
</html>
