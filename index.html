<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CineNube Gallery</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background: #121212;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  header {
    text-align: center;
    padding: 20px;
    background-color: #1f1f1f;
  }
  h1 { margin: 0; font-size: 2em; }
  #search-bar {
    margin-top: 10px;
    width: 80%;
    max-width: 500px;
    padding: 10px;
    font-size: 1em;
    border-radius: 5px;
    border: none;
  }
  nav {
    text-align: center;
    margin: 15px 0;
  }
  nav button {
    margin: 0 5px;
    padding: 8px 15px;
    font-size: 1em;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #1f1f1f;
    color: #fff;
    transition: 0.2s;
  }
  nav button.active {
    background-color: #ff3d00;
  }
  #gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    padding: 20px;
  }
  .item {
    background-color: #1e1e1e;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
  }
  .item img {
    width: 100%;
    height: 300px;
    object-fit: cover;
  }
  .content {
    padding: 10px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .title {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 5px;
  }
  .overview {
    font-size: 0.9em;
    margin-bottom: 5px;
    line-height: 1.2em;
  }
  .info {
    font-size: 0.85em;
    margin-bottom: 5px;
    color: #ccc;
  }
  .buttons {
    margin-top: auto;
  }
  .buttons a {
    display: inline-block;
    margin: 2px 2px 2px 0;
    padding: 5px 8px;
    font-size: 0.8em;
    text-decoration: none;
    border-radius: 5px;
    background-color: #ff3d00;
    color: #fff;
    transition: 0.2s;
  }
  .buttons a:hover { background-color: #ff5722; }
  .rating {
    margin-top: 5px;
  }
  .rating button {
    margin: 3px 3px 3px 0;
    padding: 4px 8px;
    font-size: 0.8em;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: 0.2s;
  }
  .rating .up { background-color: #1b5e20; color: #fff; }
  .rating .down { background-color: #b71c1c; color: #fff; }
  .rating button:hover { opacity: 0.8; }
</style>
</head>
<body>

<header>
  <h1>CineNube Gallery</h1>
  <input type="text" id="search-bar" placeholder="Buscar...">
  <nav>
    <button class="active" data-filter="all">Todo</button>
    <button data-filter="movie">Pel√≠culas</button>
    <button data-filter="series">Series</button>
  </nav>
</header>

<main id="gallery"></main>

<script>
const SHEET_JSON_URL = 'https://script.google.com/macros/s/AKfycbx1Vq5HqmPMExtgm1PRgct2WRzGex5BTEtDERIKHA20VZNFf-umdHpiKD94Df80S2vO1g/exec';
let allItems = [];

async function fetchData() {
  const res = await fetch(SHEET_JSON_URL);
  const data = await res.json();
  allItems = data.sort((a,b)=>b.published_ts - a.published_ts);
  renderItems(allItems);
}

function truncate(text, max=120) {
  if(!text) return '';
  return text.length>max? text.slice(0,max)+'...': text;
}

function renderItems(items) {
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  items.forEach(item=>{
    const card = document.createElement('div');
    card.className = 'item';

    const uniqueID = item.TMDB_ID || (item.type + '_' + btoa(item.title).slice(0,8));
    card.dataset.id = uniqueID;

    card.innerHTML = `
      <img src="${item.poster}" alt="${item.title}">
      <div class="content">
        <div class="title">${item.title}</div>
        <div class="overview">${truncate(item.overview, 120)}</div>
        <div class="info">‚≠ê ${item.rating || 'N/A'} | üìÖ ${item.year || ''}</div>
        <div class="buttons"></div>
        <div class="rating"></div>
      </div>
    `;
    const buttonsDiv = card.querySelector('.buttons');
    // Pel√≠cula
    if(item.type==='movie' && item.terabox){
      try{
        const links = JSON.parse(item.terabox);
        links.forEach((l,i)=>{
          if(l.link) buttonsDiv.innerHTML += `<a href="${l.link}" target="_blank">Ver ahora</a>`;
        });
      }catch(e){}
    }
    // Serie
    if(item.type==='series' && item.season_links){
      try{
        item.season_links.forEach(s=>{
          if(s.link) buttonsDiv.innerHTML += `<a href="${s.link}" target="_blank">Temporada ${s.season}</a>`;
        });
      }catch(e){}
    }

    // Valoraciones independientes
    const ratingDiv = card.querySelector('.rating');
    const key = 'rating_' + uniqueID;
    let votes = JSON.parse(localStorage.getItem(key)||'{"up":0,"down":0}');
    const upBtn = document.createElement('button');
    upBtn.className = 'up';
    upBtn.textContent = `üëç ${votes.up}`;
    upBtn.onclick = ()=>{
      votes.up++; localStorage.setItem(key, JSON.stringify(votes)); upBtn.textContent = `üëç ${votes.up}`;
    };
    const downBtn = document.createElement('button');
    downBtn.className = 'down';
    downBtn.textContent = `üëé ${votes.down}`;
    downBtn.onclick = ()=>{
      votes.down++; localStorage.setItem(key, JSON.stringify(votes)); downBtn.textContent = `üëé ${votes.down}`;
    };
    ratingDiv.appendChild(upBtn);
    ratingDiv.appendChild(downBtn);

    gallery.appendChild(card);
  });
}

// Filtros
document.querySelectorAll('nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const filter = btn.dataset.filter;
    renderItems(filter==='all'? allItems : allItems.filter(i=>i.type===filter));
  });
});

// Buscador
document.getElementById('search-bar').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  renderItems(allItems.filter(i=>i.title.toLowerCase().includes(q)));
});

// Inicial
fetchData();
</script>

</body>
</html>
