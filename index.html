<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CineNube Series y Películas</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #0e0e0e; color: #fff; margin:0; padding:20px;}
  .item { border: 1px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 20px; background: #1c1c1c;}
  .title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
  .overview { margin-bottom: 10px; }
  .poster { max-width: 200px; display:block; margin-bottom: 10px; border-radius:5px; }
  .btn-season, .btn-movie { display:inline-block; margin:2px; padding:6px 12px; border-radius:5px; text-decoration:none; color:#fff; background:#ff4500; }
  .btn-season:hover, .btn-movie:hover { background:#e03e00; }
</style>
</head>
<body>

<h1>CineNube</h1>
<div id="content">Cargando...</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx1Vq5HqmPMExtgm1PRgct2WRzGex5BTEtDERIKHA20VZNFf-umdHpiKD94Df80S2vO1g/exec";

function cleanSeasonLinks(raw){
    if(!raw) return [];
    try{
        if(typeof raw==="string"){
            raw = raw.trim();
            while(raw.startsWith('[[') && raw.endsWith(']]')) raw = raw.slice(1,-1);
            raw = JSON.parse(raw);
        }
        if(Array.isArray(raw)) return raw.filter(s=>s && s.season);
        return [];
    }catch(e){ return []; }
}

function createItemHTML(item){
    let html = `<div class="item">`;
    if(item.poster) html += `<img src="${item.poster}" class="poster">`;
    html += `<div class="title">${item.title} ${item.year ? "| "+item.year : ""}</div>`;
    html += `<div class="overview">${item.overview||''}</div>`;
    html += `<div>⭐ ${item.rating || 'N/A'}</div>`;
    
    // Temporadas series
    if(item.type.toLowerCase()==='series'){
        let seasons = cleanSeasonLinks(item.season_links);
        if(seasons.length>0){
            seasons.forEach(s=>{
                if(s.link) html += `<a href="${s.link}" target="_blank" class="btn-season">Temporada ${s.season}</a>`;
            });
        } else {
            html += `<div>Sin temporadas disponibles</div>`;
        }
    }
    
    // Películas
    if(item.type.toLowerCase()==='movie' && item.terabox){
        let enlace="";
        try{
            let parsed = JSON.parse(item.terabox);
            if(Array.isArray(parsed) && parsed[0] && parsed[0].link) enlace=parsed[0].link;
        }catch(e){
            let match = (item.terabox||'').match(/https?:\/\/[^\s"]+/);
            if(match) enlace=match[0];
        }
        if(enlace) html += `<a href="${enlace}" target="_blank" class="btn-movie">Ver ahora</a>`;
    }

    html += `</div>`;
    return html;
}

async function loadItems(){
    const container = document.getElementById("content");
    container.innerHTML = "Cargando...";
    try{
        let res = await fetch(API_URL);
        let data = await res.json();
        if(data.error){ container.innerHTML="Error: "+data.error; return; }
        if(!Array.isArray(data) || data.length===0){ container.innerHTML="No hay items."; return; }
        container.innerHTML = data.map(createItemHTML).join('');
    }catch(e){
        container.innerHTML = "Error al cargar los datos.";
        console.error(e);
    }
}

loadItems();
</script>

</body>
</html>
