<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CineNube</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #0e0e0e; color: #eee; margin: 0; padding: 0; min-height:100vh; }
  header { text-align: center; padding: 2rem; background: #1c1c1c; }
  h1 { margin: 0; font-size: 2.3rem; color: #ff6600; }
  nav { text-align: center; margin: 1rem 0; }
  nav button { margin: 0 0.4rem; padding: 0.5rem 1.2rem; cursor: pointer; background: #333; color: #eee; border: none; border-radius: 8px; font-size: 0.95rem; transition: 0.2s; }
  nav button.active, nav button:hover { background: #ff6600; color: #111; }

  .search-container { text-align: center; margin: 1.5rem 0; }
  .search-container input { width: 80%; max-width: 400px; padding: 0.6rem; border-radius: 6px; border: none; outline: none; font-size: 1rem; }

  section { display: flex; flex-wrap: wrap; justify-content: center; padding: 1rem; min-height: 60vh; }
  .item { background: #1b1b1b; border-radius: 10px; margin: 1rem; width: 200px; text-align: center; box-shadow: 0 0 10px #000; transition: transform 0.2s; overflow: hidden; position: relative; }
  .item:hover { transform: scale(1.03); }
  .item img { width: 100%; height: 300px; object-fit: cover; display: block; border-radius: 10px 10px 0 0; }
  .item h3 { margin: 0.5rem 0; font-size: 1.05rem; padding: 0 0.5rem; }
  .item .meta { font-size: 0.85rem; color: #bbb; margin-bottom: 0.5rem; }
  .item a { display: inline-block; margin: 0.3rem 0.2rem 0.8rem 0.2rem; padding: 0.4rem 0.6rem; background: #ff6600; color: #111; text-decoration: none; border-radius: 5px; font-weight: 600; }
  .small-link { background: #444; color: #eee; padding: 0.25rem 0.4rem; border-radius: 4px; font-size:0.85rem;}
  .hidden { display: none; }
  .message { text-align: center; color: #888; padding: 2rem; width:100%; }
  .badge-new { position: absolute; top: 8px; left: 8px; background: #2ecc71; color: #111; font-weight: bold; padding: 3px 6px; border-radius: 6px; font-size: 0.75rem; }
</style>
</head>
<body>

<header>
  <h1>CineNube</h1>
</header>

<nav>
  <button data-filter="movies" class="active">Pel√≠culas</button>
  <button data-filter="series">Series</button>
  <button data-filter="recent">Recientes</button>
</nav>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Buscar t√≠tulo, a√±o o palabra clave...">
</div>

<section id="gallery">
  <p class="message">Cargando cat√°logo...</p>
</section>

<script>
const SHEET_URL = "https://api.sheetbest.com/sheets/4b4d9aed-b6a1-414d-a2d4-5c7605b85501";
const TMDB_API_KEY = "73ec36a1669f06f8684c4d104861d52b";
const gallery = document.getElementById('gallery');
const searchInput = document.getElementById('searchInput');
let catalogo = [];

// Mensajes de donaci√≥n aleatorios
const mensajesPaypal = [
  "üçø ¬°Ey! ¬øTe gust√≥ esto? Apoya el proyecto con un cafecito ‚òïÔ∏è: https://paypal.me/CineNubes",
  "üé¨ Si disfrutas el contenido, considera invitarnos un caf√©: https://paypal.me/CineNubes",
  "üåü Tu apoyo hace posible que sigamos compartiendo estrenos ‚ù§Ô∏è https://paypal.me/CineNubes",
  "üí´ ¬øTe encanta descubrir pelis nuevas? Un peque√±o aporte ayuda mucho üëâ https://paypal.me/CineNubes",
  "üìΩÔ∏è Mant√©n activo CineNube con tu granito de arena üíñ https://paypal.me/CineNubes",
  "üî• ¬øTe gust√≥ esta recomendaci√≥n? Inv√≠tanos un caf√© ‚òïÔ∏è y seguimos compartiendo: https://paypal.me/CineNubes"
];

function parseFecha(fechaStr) {
  if (!fechaStr) return null;
  const partes = fechaStr.split("-");
  if (partes.length === 3) {
    const [dia, mes, a√±o] = partes.map(p => parseInt(p, 10));
    return new Date(a√±o, mes - 1, dia);
  }
  return new Date(fechaStr);
}

// Trae informaci√≥n TMDB din√°mica (poster y overview √∫ltimo episodio)
async function fetchTMDB(item) {
  if (!item.TMDB_ID) return item;
  try {
    const type = item.type === 'movie' ? 'movie' : 'tv';
    const res = await fetch(`https://api.themoviedb.org/3/${type}/${item.TMDB_ID}?api_key=${TMDB_API_KEY}&language=es-ES`);
    const data = await res.json();

    if (!data) return item;

    item.overview = data.overview || item.overview;
    item.rating = data.vote_average || item.rating;
    item.poster = data.poster_path ? `https://image.tmdb.org/t/p/w600_and_h900_bestv2${data.poster_path}` : item.poster;

    if (item.type === 'series') {
      const lastEp = data.last_episode_to_air || null;
      if (lastEp) {
        item.last_episode_still = lastEp.still_path ? `https://image.tmdb.org/t/p/w600_and_h900_bestv2${lastEp.still_path}` : item.poster;
        item.last_episode_overview = lastEp.overview || item.overview;
        item.last_episode_air_date = lastEp.air_date;
      }
      item.season_links = data.seasons ? JSON.stringify(data.seasons.map(s=>({season:s.season_number, link:''}))) : item.season_links;
    }
  } catch(e) {
    console.error("Error TMDB:", e);
  }
  return item;
}

async function showItems(filter, query = '') {
  gallery.innerHTML = '';
  const hoy = new Date();
  const normalize = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  let items = catalogo.filter(i => {
    if (filter === 'movies') return i.type === 'movie';
    if (filter === 'series') return i.type === 'series';
    if (filter === 'recent') {
      const fecha = parseFecha(i.updated || i.added);
      if (!fecha) return false;
      const diasDiff = (hoy - fecha) / (1000*60*60*24);
      return diasDiff <= 15;
    }
    return true;
  });

  if (query) {
    const nq = normalize(query);
    items = items.filter(i =>
      normalize(i.title || '').includes(nq) ||
      normalize(i.overview || '').includes(nq) ||
      (i.year && i.year.toString().includes(nq))
    );
  }

  if (!items.length) {
    gallery.innerHTML = '<p class="message">No se encontr√≥ contenido.</p>';
    return;
  }

  items.sort((a, b) => {
    const fa = parseFecha(a.updated || a.added);
    const fb = parseFecha(b.updated || b.added);
    return fb - fa;
  });

  for (let item of items) {
    // Actualiza info de TMDB antes de mostrar
    await fetchTMDB(item);

    const div = document.createElement('div');
    div.className = 'item';

    const img = document.createElement('img');
    img.src = item.last_episode_still || item.poster || 'https://via.placeholder.com/200x300?text=Sin+Imagen';
    img.alt = item.title || 'Sin t√≠tulo';

    const h3 = document.createElement('h3');
    h3.textContent = item.title || 'Sin t√≠tulo';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = (item.year ? item.year + ' ¬∑ ' : '') + (item.type === 'movie' ? 'Pel√≠cula' : 'Serie');

    const resumen = document.createElement('div');
    resumen.style.fontSize = '0.85rem';
    resumen.style.color = '#ccc';
    resumen.style.margin = '0.5rem';
    const texto = (item.last_episode_overview || item.overview || '').trim();
    resumen.textContent = texto.length > 120 ? texto.slice(0,120) + '...' : texto;

    // Badge ‚ÄúNuevo‚Äù
    let fechaNuevo = parseFecha(item.updated || item.added);
    if (item.type === 'series' && item.last_episode_air_date) {
      const epDate = parseFecha(item.last_episode_air_date);
      if (epDate) fechaNuevo = epDate;
    }
    if (fechaNuevo && ((hoy - fechaNuevo) / (1000*60*60*24)) <= 3) {
      const badge = document.createElement('div');
      badge.className = 'badge-new';
      badge.textContent = 'üü¢ Nuevo';
      div.appendChild(badge);
    }

    div.appendChild(img);
    div.appendChild(h3);
    div.appendChild(meta);
    div.appendChild(resumen);

    if (item.type === 'movie' && item.terabox) {
      const link = document.createElement('a');
      link.href = item.terabox;
      link.target = '_blank';
      link.textContent = 'Ver Pel√≠cula';
      div.appendChild(link);
    }

    if (item.type === 'series' && item.season_links) {
      try {
        const seasons = JSON.parse(item.season_links);
        seasons.forEach(s => {
          if (s.link) {
            const btn = document.createElement('a');
            btn.href = s.link;
            btn.target = '_blank';
            btn.className = 'small-link';
            btn.textContent = `Temporada ${s.season}`;
            div.appendChild(btn);
          }
        });
      } catch(e) { console.error("Error en season_links", e); }
    }

    // Mensaje PayPal aleatorio
    const mensajePay = mensajesPaypal[Math.floor(Math.random()*mensajesPaypal.length)];
    const p = document.createElement('p');
    p.style.fontSize = '0.75rem';
    p.style.color = '#ccc';
    p.style.margin = '0.3rem';
    p.textContent = mensajePay;
    div.appendChild(p);

    gallery.appendChild(div);
  }
}

fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {
    catalogo = data.filter(row => row.title);
    showItems('movies');
  })
  .catch(err => {
    gallery.innerHTML = '<p class="message" style="color:tomato;">‚ùå Error cargando datos.</p>';
    console.error(err);
  });

const buttons = document.querySelectorAll('nav button');
buttons.forEach(btn => {
  btn.addEventListener('click', () => {
    buttons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    showItems(btn.dataset.filter, searchInput.value);
  });
});

searchInput.addEventListener('input', e => {
  const filter = document.querySelector('nav button.active').dataset.filter;
  showItems(filter, e.target.value);
});
</script>

</body>
</html>
