<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CineNube Gallery</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;background:#0e0e0e;color:#fff;margin:0;padding:0;overflow-x:hidden}
  header{background:#1c1c1c;padding:18px;text-align:center;font-size:24px;font-weight:700;color:#00aaff;box-shadow:0 0 8px rgba(0,0,0,.5)}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:center;padding:10px;background:#141414;flex-wrap:wrap}
  .search { width:320px; max-width:80%; padding:8px 12px;border-radius:8px;border:1px solid #2b2b2b;background:#0f0f0f;color:#fff }
  nav{display:flex;justify-content:center;gap:14px;background:#141414;padding:10px 8px;font-weight:700;flex-wrap:wrap}
  nav button{background:none;border:1px solid transparent;color:#fff;cursor:pointer;font-size:15px;padding:6px 10px;border-radius:6px;transition:all .18s}
  nav button.active{border-color:rgba(0,170,255,.18);background:rgba(0,170,255,.03);color:#00aaff}
  nav button:hover{color:#00aaff}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:18px}
  .item{background:#141414;border-radius:12px;overflow:hidden;text-align:left;box-shadow:0 0 10px rgba(0,0,0,0.6);transition:transform .18s,box-shadow .18s;position:relative;display:flex;flex-direction:column;height:460px}
  .item:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,170,255,.08)}
  .thumb{height:300px;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;border-bottom:3px solid #00aaff}
  .content{padding:10px 12px;display:flex;flex-direction:column;flex:1}
  .title{color:#00aaff;font-size:16px;margin:6px 0 4px;height:40px;overflow:hidden}
  .overview{font-size:13px;color:#ccc;line-height:1.2;height:66px;overflow:hidden;margin-bottom:8px}
  .meta{font-size:12px;color:#99e6ff;margin-bottom:8px}
  .btn{margin-top:auto;display:block;background:#00aaff;color:#fff;text-decoration:none;padding:10px;border-radius:0 0 12px 12px;font-weight:700;text-align:center}
  .btn.disabled{background:#333;cursor:default}
  .tag{position:absolute;top:12px;left:12px;background:#00aaff;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  .new{position:absolute;top:12px;right:12px;background:#ff2d55;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
  .empty{padding:40px;text-align:center;color:#aaa}
</style>
</head>
<body>
<header>üé¨ CineNube Gallery</header>

<div class="topbar">
  <input id="search" class="search" placeholder="Buscar t√≠tulo, g√©nero, a√±o..." />
</div>

<nav id="nav">
  <button data-filter="all" class="active">üîÅ Todos</button>
  <button data-filter="movie">üé• Pel√≠culas</button>
  <button data-filter="series">üì∫ Series</button>
</nav>

<div id="gallery"></div>

<script>
const SHEET_URL='https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec';
let allData=[],filteredData=[];

function parsePossiblyInvalidJSON(str){
  if(!str) return null;
  try{return JSON.parse(str);}catch(e){}
  try{
    const fixed=str.replace(/'/g,'"').replace(/([{,])(\s*)(\w+)(\s*):/g,'$1"$3":');
    return JSON.parse(fixed);
  }catch(e){return null;}
}

function normalizeItem(r){
  let it={};
  it.title=r.title||r.titulo||'';
  it.poster=r.poster||r.imagen||'';
  it.overview=r.overview||r.descripcion||'';
  it.year=r.year||'';
  it.type=(r.type||r.tipo||'movie').toString().trim().toLowerCase();
  if(['serie','series','tv'].includes(it.type)) it.type='series';
  if(['pelicula','pel√≠cula','film'].includes(it.type)) it.type='movie';
  it.terabox=r.terabox||r.link||'';
  it.season_links=r.season_links||r.seasons||'';
  it.published_ts=Date.parse(r.published_at||r.updated||r.year)||0;
  return it;
}

function getFirstLink(it){
  const arr=parsePossiblyInvalidJSON(it.season_links);
  if(Array.isArray(arr)){
    for(const s of arr){
      if(s&&s.link&&s.link.trim()!=='') return s.link.trim();
    }
  }
  if(it.terabox){
    const arr2=parsePossiblyInvalidJSON(it.terabox);
    if(Array.isArray(arr2)){
      for(const s of arr2){if(s&&s.link&&s.link.trim()!=='')return s.link.trim();}
    }
    const m=it.terabox.toString().match(/https?:\/\/[^\s"']+/);
    if(m) return m[0];
  }
  return '#';
}

function normalizeLink(l){
  if(!l) return '#';
  const s=String(l).trim();
  return s.startsWith('http')?s:'#';
}

function getSeasonButtonsHtml(it){
  const arr=parsePossiblyInvalidJSON(it.season_links);
  if(!Array.isArray(arr)) return '';
  let html='',hasAny=false;
  for(const s of arr){
    if(!s||s.season===undefined) continue;
    const link=normalizeLink(s.link);
    if(link&&link!=='#'){hasAny=true;html+=` <a class="btn" href="${link}" target="_blank">üì∫ T${s.season}</a>`;}
    else html+=` <a class="btn disabled" href="javascript:void(0)">üîí T${s.season}</a>`;
  }
  return hasAny?html:'';
}

function renderGallery(list){
  const g=document.getElementById('gallery');
  g.innerHTML='';
  if(!list.length){g.innerHTML='<div class="empty">No hay resultados</div>';return;}
  const now=Date.now();
  for(const it of list){
    const tipo=it.type==='series'?'series':'movie';
    const tipoTexto=tipo==='series'?'üì∫ Serie':'üé• Pel√≠cula';
    const btnText=tipo==='series'?'üì∫ Ver temporada':'üé• Ver pel√≠cula';
    const poster=it.poster.startsWith('http')?it.poster:'https://image.tmdb.org/t/p/w500'+it.poster;
    const primary=normalizeLink(getFirstLink(it));
    const seasons=getSeasonButtonsHtml(it);
    const hasLink=(primary&&primary!=='#')||seasons.trim()!=='';
    const isNew=it.published_ts?((now-it.published_ts)<86400000):false;

    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div class="thumb"><img src="${poster}" alt="${it.title}"></div>
      <div class="content">
        <div class="title">${it.title}</div>
        <div class="overview">${it.overview}</div>
        <div class="meta">${it.year}</div>
        ${hasLink?`<a class="btn" href="${primary}" target="_blank">${btnText}</a>`:`<a class="btn disabled">Enlace no disponible</a>`}
        <div style="margin-top:8px">${seasons}</div>
      </div>
      <span class="tag">${tipoTexto}</span>
      ${isNew?'<span class="new">üÜï Nuevo</span>':''}
    `;
    g.appendChild(div);
  }
}

async function loadData(){
  const res=await fetch(SHEET_URL);
  const data=await res.json();
  allData=data.map(normalizeItem);
  renderGallery(allData);
}

loadData();
</script>
</body>
</html>
