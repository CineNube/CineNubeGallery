<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CineNube Netflix</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background:#0e0e0e; color:#fff; margin:0; }
  header { background:#1c1c1c; padding:20px; text-align:center; font-size:26px; font-weight:bold; color:#00aaff; box-shadow:0 0 10px rgba(0,0,0,.5);}
  nav { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; padding:10px; background:#141414; }
  nav button { border:none; background:#222; color:#fff; padding:8px 14px; border-radius:6px; cursor:pointer; transition:all .2s; font-weight:700; }
  nav button.active, nav button:hover { background:#00aaff; color:#fff; }
  #gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px; padding:20px; }
  .item { background:#1a1a1a; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; height:450px; transition: transform .2s, box-shadow .2s; }
  .item:hover { transform:translateY(-6px); box-shadow:0 10px 30px rgba(0,170,255,.2); }
  .thumb { height:280px; overflow:hidden; }
  .thumb img { width:100%; height:100%; object-fit:cover; display:block; border-bottom:3px solid #00aaff; }
  .content { padding:12px; display:flex; flex-direction:column; flex:1; }
  .title { font-size:17px; color:#00aaff; margin:6px 0 4px; height:40px; overflow:hidden; }
  .overview { font-size:14px; color:#ccc; line-height:1.2; height:60px; overflow:hidden; margin-bottom:6px; }
  .meta { font-size:13px; color:#9aaebf; margin-bottom:6px; }
  .btn { display:inline-block; background:#00aaff; color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:700; margin:2px 2px 0 0; font-size:13px; text-align:center; }
  .new { position:absolute; top:10px; right:10px; background:#ff2d55; color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:700; }
  .typeTag { position:absolute; top:10px; left:10px; background:#00aaff; color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:700; }
  .empty { padding:40px; text-align:center; color:#aaa; }
  @media(max-width:700px){ .item { height:420px; } .thumb { height:260px; } }
</style>
</head>
<body>
<header>üé¨ CineNube Netflix</header>
<nav id="nav">
  <button data-filter="all" class="active">üîÅ Todos</button>
  <button data-filter="recientes">üî• Recientes (24h)</button>
  <button data-filter="movie">üé• Pel√≠culas</button>
  <button data-filter="series">üì∫ Series</button>
</nav>
<div id="gallery"></div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbz0AxlhwQ5-8hnnRMnhP8S-i0xQoUg3iWoEYXbT5o_ltCpR7mAIZqPaHqccFzkC34cLbw/exec';
let allData = [];

function safeParseJSON(s){ try{ return JSON.parse(s); }catch(e){ return null; } }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function parseDatePrefer(obj){ if(!obj) return null; const c=[obj.published_at,obj.updated,obj.updated_at,obj.year]; for(const x of c){ if(!x) continue; const t=Date.parse(x); if(!isNaN(t)) return t; } return null; }
function normalizeLink(raw){ if(!raw) return '#'; const s=String(raw).trim(); if(s.startsWith('http')) return s; if(s === '#') return '#'; return 'https://cinenube.github.io/CineNubeGallery/' + s.replace(/^\/+/,''); }
function shouldOpenBlank(url){ try{ const u=new URL(url); return u.hostname !== location.hostname; }catch(e){ return false; } }

function normalizeItem(raw){
  let it = {};
  it.title = raw.title||raw.titulo||raw.name||'Sin t√≠tulo';
  it.poster = raw.poster||raw.imagen||'';
  it.overview = raw.overview||raw.descripcion||'';
  it.rating = raw.rating||'';
  it.year = raw.year||'';
  it.type = (function(t){ if(!t) return 'movie'; const s=String(t||'').toLowerCase(); if(s==='tv'||s==='series'||s==='serie') return 'series'; return 'movie'; })(raw.type||raw.tipo);
  it.terabox = raw.terabox||'';
  it.season_links = raw.season_links||'';
  it.published_ts = parseDatePrefer(raw);
  return it;
}

function getFirstLink(it){
  if(it.terabox){
    const p = safeParseJSON(it.terabox);
    if(Array.isArray(p) && p[0] && p[0].link) return p[0].link;
    const m = (it.terabox||'').match(/https?:\/\/[^\s"']+/); if(m) return m[0]; if(String(it.terabox).trim()) return String(it.terabox).trim();
  }
  if(it.season_links){
    const s = safeParseJSON(it.season_links);
    if(Array.isArray(s) && s[0] && s[0].link) return s[0].link;
    const m = (it.season_links||'').match(/https?:\/\/[^\s"']+/); if(m) return m[0]; if(String(it.season_links).trim()) return String(it.season_links).trim();
  }
  return '#';
}

function getSeasonButtonsHtml(item){
  if(!item.season_links) return '';
  const parsed = safeParseJSON(item.season_links);
  if(!Array.isArray(parsed)) return '';
  let html = '';
  parsed.forEach(s=>{
    if(s && s.link){
      const link = normalizeLink(s.link);
      const blank = (link.startsWith('http') && !link.includes('cinenube.github.io')) ? ' target="_blank"':''; 
      html += `<a class="btn" href="${escapeHtml(link)}"${blank}>üì∫ T${s.season}</a>`;
    }
  });
  return html;
}

async function loadGallery(){
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();
    if(!Array.isArray(data)){ document.getElementById('gallery').innerHTML='<div class="empty">No hay datos</div>'; return; }
    allData = data.map(normalizeItem).sort((a,b)=> (b.published_ts||0)-(a.published_ts||0));
    renderGallery(allData);
  } catch(e){ console.error(e); document.getElementById('gallery').innerHTML='<div class="empty">Error cargando datos</div>'; }
}

function renderGallery(list){
  const g = document.getElementById('gallery'); g.innerHTML='';
  if(!list.length){ g.innerHTML='<div class="empty">No hay resultados</div>'; return; }
  const now = Date.now();
  list.forEach(it=>{
    const tipoTexto = it.type==='series'?'üì∫ Serie':'üé• Pel√≠cula';
    const primary = normalizeLink(getFirstLink(it));
    const blank = shouldOpenBlank(primary)?' target="_blank"':'';
    const seasonBtns = getSeasonButtonsHtml(it);
    const posterUrl = it.poster&&it.poster.startsWith('http')?it.poster:(it.poster?('https://image.tmdb.org/t/p/w500'+it.poster):'');
    const isNew = it.published_ts?((now-it.published_ts)<1000*60*60*24):false;
    const div = document.createElement('div'); div.className='item';
    div.innerHTML=`
      <div class="thumb"><img src="${encodeURI(posterUrl||'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=600 height=900><rect width=100% height=100% fill=%23111/><text x=50% y=50% fill=%23aaa font-size=20 font-family=Arial text-anchor=middle>Sin imagen</text></svg>')}" alt="${escapeHtml(it.title)}"></div>
      <div class="content">
        <div class="title">${escapeHtml(it.title)}</div>
        <div class="overview">${escapeHtml(it.overview)}</div>
        <div class="meta">${it.rating?'‚≠ê '+escapeHtml(it.rating):''}${it.year?' ‚Ä¢ '+escapeHtml(it.year):''}</div>
        <a class="btn" href="${escapeHtml(primary)}"${blank}>${it.type==='series'?'üì∫ Ver temporada':'üé¨ Ver pel√≠cula'}</a>
        <div style="margin-top:6px">${seasonBtns}</div>
      </div>
      <span class="typeTag">${tipoTexto}</span>
      ${isNew?'<span class="new">üÜï Nuevo</span>':''}
    `;
    g.appendChild(div);
  });
}

document.getElementById('nav').addEventListener('click', e=>{
  const btn = e.target.closest('button[data-filter]'); if(!btn) return;
  const filter = btn.dataset.filter;
  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(filter==='all'){ renderGallery(allData); }
  else if(filter==='recientes'){ renderGallery(allData.filter(i=>i.published_ts && ((Date.now()-i.published_ts)<=1000*60*60*24))); }
  else if(filter==='movie'){ renderGallery(allData.filter(i=>i.type==='movie')); }
  else if(filter==='series'){ renderGallery(allData.filter(i=>i.type==='series')); }
});

loadGallery();
</script>
</body>
</html>
